#!/usr/bin/env bash
# template-task: 1.9.0
#######################################
# Copyright SerDigital64 - https://github.com/serdigital64
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#######################################

# shellcheck source=bin/dev-set
source ./bin/dev-set || { echo 'dev-set:Error: unable to load dev environment' 2>&1 && exit 1; }
# shellcheck source-path=/opt/bl64
source "${DEV_LIB_BASHLIB64_TARGET}/bashlib64-module-fs.bash" &&
  source "${DEV_LIB_BASHLIB64_TARGET}/bashlib64-module-txt.bash" &&
  source "${DEV_LIB_BASHLIB64_TARGET}/bashlib64-module-xsv.bash" &&
  source "${DEV_LIB_BASHLIB64_TARGET}/bashlib64-module-fmt.bash" &&
  source "${DEV_LIB_BASHLIB64_TARGET}/bashlib64-module-bsh.bash" &&
  source "${DEV_LIB_BASHLIB64_TARGET}/bashlib64-core.bash" || exit 1
# shellcheck source-path=bin
source ./bin/dev-env-iac64 || exit 1

declare MY_COMMAND="${1:-$BL64_VAR_NULL}"
declare MY_OPTION=''
declare MY_PROFILE=''
declare MY_MODULE=''
declare MY_VERSION=''
declare MY_SHARED='0.1.0'
declare MY_DRIVER_NAME=''
declare MY_DRIVER_TAG=''
declare MY_CONFIRMATION='NONE'

declare MY_COMMAND_BLT='blt'
declare MY_COMMAND_BUILD='build'
declare MY_COMMAND_CONSOLE='console'
declare MY_COMMAND_DEPLOY='deploy'
declare MY_COMMAND_HELP='help'
declare MY_COMMAND_INIT='init'
declare MY_COMMAND_LINT='lint'
declare MY_COMMAND_NONE='none'
declare MY_COMMAND_REMOVE='remove'
declare MY_COMMAND_SAST='sast'
declare MY_COMMAND_TEST='test'

declare MY_FLAG_CONFIRM_DEPLOY='CONFIRM_DEPLOY'
declare MY_FLAG_CONFIRM_REMOVE='CONFIRM_REMOVE'

declare MY_TASK=''

# shellcheck disable=SC1090,SC2086,SC2035
function my_env_import() {
  bl64_dbg_app_show_function
  local dotenv=''

  if [[ -d "$DEV_ENV_IAC64_PATH_ETC_MODULE" ]]; then
    cd "$DEV_ENV_IAC64_PATH_ETC_MODULE" || return $?
    for dotenv in $(bl64_bsh_pattern_match_file *${DEV_ENV_IAC64_FILE_DOTENV}); do
      bl64_msg_show_task "importing shell environment file (${dotenv})"
      source "$dotenv" || return $?
    done
  fi

  if [[ -d "$DEV_ENV_IAC64_PATH_ETC_SHARED" ]]; then
    cd "$DEV_ENV_IAC64_PATH_ETC_SHARED" || return $?
    for dotenv in $(bl64_bsh_pattern_match_file *${DEV_ENV_IAC64_FILE_DOTENV}); do
      bl64_msg_show_task "importing shell environment file (${dotenv})"
      source "$dotenv" || return $?
    done
  fi
  # shellcheck disable=SC2164
  cd "$DEV_PATH_ROOT"
}

function my_run_command() {
  bl64_check_command "$MY_TASK" "the requested command for the driver is not available (${MY_TASK})" ||
    return $?
  "$MY_TASK"
}

function my_msg_task_not_implemented() {
  bl64_msg_show_warning 'the command is not available for the current driver. No further action taken.'
}

function my_run_blt() {
  bl64_dbg_app_show_function
  bl64_msg_show_phase "$MY_COMMAND_BUILD"
  MY_TASK="${DEV_PATH_BIN}/dev-${MY_COMMAND_BUILD}-iac64-${MY_DRIVER_NAME}"
  my_run_command "$MY_COMMAND_BUILD" &&
    bl64_msg_show_phase "$MY_COMMAND_LINT" &&
    MY_TASK="${DEV_PATH_BIN}/dev-${MY_COMMAND_LINT}-iac64-${MY_DRIVER_NAME}" &&
    my_run_command &&
    bl64_msg_show_phase "$MY_COMMAND_TEST" &&
    MY_TASK="${DEV_PATH_BIN}/dev-${MY_COMMAND_TEST}-iac64-${MY_DRIVER_NAME}" &&
    my_run_command
}

function my_run_console() {
  bl64_dbg_app_show_function
  bl64_fs_dir_create "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$BL64_VAR_DEFAULT" "$DEV_ENV_IAC64_PATH_VAR_MODULE" &&
    cd "$DEV_ENV_IAC64_PATH_VAR_MODULE" &&
    bl64_msg_show_info 'Starting interactive console in the staging area. To exit, type "exit" or press Ctrl+D.' &&
    /usr/bin/env "$SHELL"
}

function my_run() {
  bl64_dbg_app_show_function

  my_env_export &&
    my_env_import ||
    return $?

  case "$MY_COMMAND" in
    "$MY_COMMAND_DEPLOY")
      if [[ "$MY_CONFIRMATION" == "$MY_FLAG_CONFIRM_DEPLOY" ]]; then
        DEV_DEPLOY_IAC64_GUARDRAIL_ENABLED='NO'
      fi
      my_run_command
      ;;
    "$MY_COMMAND_REMOVE")
      if [[ "$MY_CONFIRMATION" == "$MY_FLAG_CONFIRM_REMOVE" ]]; then
        DEV_REMOVE_IAC64_GUARDRAIL_ENABLED='NO'
      fi
      my_run_command
      ;;
    "$MY_COMMAND_CONSOLE") my_run_console ;;
    "$MY_COMMAND_BLT") my_run_blt ;;
    "$MY_COMMAND_NONE") my_msg_task_not_implemented ;;
    *) my_run_command ;;
  esac
}

function my_env_export() {
  bl64_dbg_app_show_function
  bl64_dbg_app_show_info 'DevBin64 settings'
  DEV_VERBOSE='TIME'
  DEV_PROFILE="$MY_PROFILE"
  source ./bin/dev-set || return $?

  bl64_dbg_app_show_info 'IAC64 settings'
  DEV_ENV_IAC64_PROFILE="$MY_PROFILE"
  DEV_ENV_IAC64_MODULE_ID="$MY_MODULE"
  DEV_ENV_IAC64_MODULE_VERSION="$MY_VERSION"
  DEV_ENV_IAC64_MODULE_SHARED="$MY_SHARED"

  DEV_ENV_IAC64_PATH_ETC_MODULE="${DEV_PATH_PROF_ETC}/${MY_MODULE}/${MY_DRIVER_TAG}/${MY_VERSION}"
  DEV_ENV_IAC64_PATH_ETC_SHARED="${DEV_PATH_PROF_ETC}/${DEV_BUILD_IAC64_SHARED}/${MY_DRIVER_TAG}/${MY_SHARED}"
  DEV_ENV_IAC64_PATH_LOGS_MODULE="${DEV_PATH_PROF_LOGS}/${MY_DRIVER_TAG}/${MY_MODULE}/${MY_VERSION}"
  DEV_ENV_IAC64_PATH_SRC_MODULE="${DEV_PATH_SRC}/${MY_MODULE}/${MY_DRIVER_TAG}/${MY_VERSION}"
  DEV_ENV_IAC64_PATH_SRC_SHARED="${DEV_PATH_SRC}/${DEV_BUILD_IAC64_SHARED}/${MY_DRIVER_TAG}/${MY_SHARED}"
  DEV_ENV_IAC64_PATH_TMP_MODULE="${DEV_PATH_PROF_TMP}/${MY_MODULE}/${MY_DRIVER_TAG}/${MY_VERSION}"
  DEV_ENV_IAC64_PATH_VAR_MODULE="${DEV_PATH_PROF_VAR}/${MY_MODULE}/${MY_DRIVER_TAG}/${MY_VERSION}"

  bl64_dbg_app_show_info 'OpenTofu settings'
  TF_VAR_iac64__profile_name="$MY_PROFILE"
}

function my_initialize() {
  bl64_dbg_app_show_function
  bl64_msg_show_about

  case "$MY_COMMAND" in
    "$MY_COMMAND_INIT")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_BASH" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_BUILD")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_HELM" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_KUSTOMIZE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_BASH" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_BLT")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_HELM" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_KUSTOMIZE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_BASH" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_LINT")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_HELM" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_BASH" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_SAST")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_HELM" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_KUSTOMIZE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_BASH" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_TEST")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_HELM" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE" || "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_BASH" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_REMOVE")
      [[ "$MY_DRIVER_NAME" == "$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE" ]] &&
        MY_COMMAND="$MY_COMMAND_NONE"
      ;;
    "$MY_COMMAND_DEPLOY") ;;
    "$MY_COMMAND_CONSOLE") ;;
    *)
      bl64_msg_show_error 'there is no such command'
      return 1
      ;;
  esac

  MY_TASK="${DEV_PATH_BIN}/dev-${MY_COMMAND}-iac64-${MY_DRIVER_NAME}"
  bl64_lib_script_minver_check '22.5.0' &&
    bl64_check_parameter 'MY_PROFILE' &&
    bl64_check_parameter 'MY_MODULE' &&
    bl64_check_parameter 'MY_VERSION' &&
    bl64_check_parameter 'MY_DRIVER_NAME' &&
    bl64_msg_show_setup "$BL64_VAR_DEFAULT" \
      'MY_PROFILE' \
      'MY_MODULE' \
      'MY_VERSION' \
      'MY_SHARED' \
      'MY_DRIVER_NAME'
}

bl64_lib_script_version_set '2.1.0'
bl64_msg_help_usage_set 'iac64 <COMMAND> <-p profile> <-m module> <-v version> <-A|-B|-H|-K|-O> [-s shared] [-D Debug] [-h]'
bl64_msg_help_about_set 'Opinionated Infrastructure-as-Code (IaC) development and deployment tool.'
bl64_msg_help_parameters_set \
  "Commands:

${MY_COMMAND_BUILD}      : Prepare the staging area from the module source code
${MY_COMMAND_LINT}       : Lint the source on the staging area
${MY_COMMAND_TEST}       : Test the source on the staging area
${MY_COMMAND_BLT}        : Combine build, lint and test operations
${MY_COMMAND_SAST}       : Run static application security testing on the source code on the staging area
${MY_COMMAND_DEPLOY}     : Deploy source code from the staging area to the target infrastructure. WARNING: destructive action.
${MY_COMMAND_REMOVE}     : Remove deployed infrastructure. WARNING: destructive action.
${MY_COMMAND_CONSOLE}    : Run interactive console in the staging area.
${MY_COMMAND_HELP}       : Show this help message.

Target
-p profile : configuration profile name
-m module  : module name.
-v version : module version.
-s shared  : (optional) shared module version

Driver
-A  : Ansible driver
-B  : Bash driver
-H  : Helm driver
-K  : Kustomize driver
-O  : OpenTofu driver

Guardrail
-Z confirm : confirm destructive actions (deploy/remove). Valid values: ${MY_FLAG_CONFIRM_DEPLOY}, ${MY_FLAG_CONFIRM_REMOVE}

Options
-V format  : verbose message format. Format: FULL|PLAIN|CALLER|TIME|HOST
-D Debug   : Enable debugging mode. Format: ALL|LIB|APP"

[[ "$MY_COMMAND" == "$MY_COMMAND_HELP" ]] && bl64_msg_help_show && exit 0
shift
# shellcheck disable=SC2249
while getopts ':p:m:v:s:Z:V:D:ABHKO' MY_OPTION; do
  case "${MY_OPTION:-}" in
    p) MY_PROFILE="$OPTARG" ;;
    m) MY_MODULE="$OPTARG" ;;
    v) MY_VERSION="$OPTARG" ;;
    s) MY_SHARED="$OPTARG" ;;
    Z) MY_CONFIRMATION="$OPTARG" ;;
    V) DEV_VERBOSE="$OPTARG" ;;
    D) DEV_CICD_DEBUG="$OPTARG" ;;
    A)
      MY_DRIVER_NAME="$DEV_ENV_IAC64_DRIVER_NAME_ANSIBLE"
      MY_DRIVER_TAG="$DEV_ENV_IAC64_DRIVER_TAG_ANSIBLE"
      ;;
    B)
      MY_DRIVER_NAME="$DEV_ENV_IAC64_DRIVER_NAME_BASH"
      MY_DRIVER_TAG="$DEV_ENV_IAC64_DRIVER_TAG_BASH"
      ;;
    H)
      MY_DRIVER_NAME="$DEV_ENV_IAC64_DRIVER_NAME_HELM"
      MY_DRIVER_TAG="$DEV_ENV_IAC64_DRIVER_TAG_HELM"
      ;;
    K)
      MY_DRIVER_NAME="$DEV_ENV_IAC64_DRIVER_NAME_KUSTOMIZE"
      MY_DRIVER_TAG="$DEV_ENV_IAC64_DRIVER_TAG_KUSTOMIZE"
      ;;
    O)
      MY_DRIVER_NAME="$DEV_ENV_IAC64_DRIVER_NAME_OPENTOFU"
      MY_DRIVER_TAG="$DEV_ENV_IAC64_DRIVER_TAG_OPENTOFU"
      ;;
  esac
done
bl64_dbg_set_level "${DEV_CICD_DEBUG:-NONE}" && bl64_msg_set_format "$DEV_VERBOSE" && bl64_msg_all_enable_verbose && bl64_dbg_set_level "$DEV_CICD_DEBUG" && my_initialize || exit $?

bl64_msg_show_batch_start "${BL64_SCRIPT_ID}:$MY_COMMAND"
my_run
bl64_msg_show_batch_finish $? "${BL64_SCRIPT_ID}:$MY_COMMAND"
