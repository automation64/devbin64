#!/usr/bin/env bash
# Template: 1.1.1
#######################################
# Dev / Bootstrap
#
# * Boostrap repository creation:
#   * create basic directory structure
#   * download Installer64 and Bashlib64 tools
#   * publish base DevBin64 modules
#   * publish optional DevBin64 modules (defined in shell-env $DEV_BOOTSTRAP_MODULES or file $DEV_BOOTSTRAP_MODULES_OPTIONAL)
# * If the repository is already present, refresh content from local store
#
# Author: SerDigital64 (https://github.com/serdigital64)
# Repository: https://github.com/automation64/devbin64
# Version: 7.0.0
#
#######################################
# Copyright SerDigital64 - https://github.com/serdigital64
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at: http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#######################################

#
# Bootstrap
#

# Verify that the current shell is supported
if [ -z "$BASH_VERSION" ]; then
  echo "Fatal: BashLib64 is not supported in the current shell (shell: $SHELL)"
  exit 1
elif [ "${BASH_VERSINFO[0]}" -lt 4 ]; then
  echo "Fatal: BashLib64 requires Bash V4 or greater (current-version: ${BASH_VERSION})"
  exit 1
fi

# Do not inherit aliases and commands
builtin unset -f unalias
builtin unalias -a
builtin unset -f command
builtin hash -r

# Normalize shtop defaults
builtin shopt -qu \
  'dotglob' \
  'extdebug' \
  'failglob' \
  'globstar' \
  'gnu_errfmt' \
  'huponexit' \
  'lastpipe' \
  'login_shell' \
  'nocaseglob' \
  'nocasematch' \
  'nullglob' \
  'xpg_echo'
builtin shopt -qs \
  'extquote'

# Ensure pipeline exit status is failed when any cmd fails
builtin set -o 'pipefail'

# Enable error processing
builtin set -o 'errtrace'
builtin set -o 'functrace'

# Disable fast-fail. Developer must implement error handling (check for exit status)
builtin set +o 'errexit'

# Reset bash set options to defaults
builtin set -o 'braceexpand'
builtin set -o 'hashall'
builtin set +o 'allexport'
builtin set +o 'histexpand'
builtin set +o 'history'
builtin set +o 'ignoreeof'
builtin set +o 'monitor'
builtin set +o 'noclobber'
builtin set +o 'noglob'
builtin set +o 'nolog'
builtin set +o 'notify'
builtin set +o 'onecmd'
builtin set +o 'posix'

# Do not set/unset - Breaks bats-core
# set -o 'keyword'
# set -o 'noexec'

# Do not inherit sensitive environment variables
builtin unset CDPATH
builtin unset ENV
builtin unset IFS
builtin unset MAIL
builtin unset MAILPATH

#
# Parameters
#

# Automation64 / Root path
declare DEV_AT64_HOME='/opt'
[[ ! -d "$DEV_AT64_HOME/bl64" && -d "${HOME}/at64/bl64" ]] && DEV_AT64_HOME="${HOME}/at64"

# DevBootstrap / Installation path
declare DEV_BOOTSTRAP_PATH_ROOT="${DEV_BOOTSTRAP_PATH_ROOT:-${DEV_AT64_HOME}/devbin64}"

# DevBootstrap / List of optional modules for adding after bootstrap is complete
declare DEV_BOOTSTRAP_MODULES="${DEV_BOOTSTRAP_MODULES:-}"

# DevSet / Debugging
export DEV_CICD_DEBUG="${DEV_CICD_DEBUG:-}"

#
# Globals
#

# DevBootstrap / Current version
declare DEV_BIN64_VERSION='10.1.2'

# DevBootstrap / Base libs
declare DEV_BOOTSTRAP_BASHLIB64_NAME='bl64'
declare DEV_BOOTSTRAP_INSTALLER64_NAME='inst64'

# DevBootstrap / Default permissions
declare DEV_BOOTSTRAP_DIR_MODE='0755'
declare DEV_BOOTSTRAP_FILE_MODE='0644'

# DevBootstrap / GitIgnore template
declare DEV_BOOTSTRAP_DOT_GITIGNORE='dot.gitignore'
# DevBootstrap / State file name
declare DEV_BOOTSTRAP_STATE='.devbin64'
# DevBootstrap / Optional modules
declare DEV_BOOTSTRAP_MODULES_OPTIONAL="${DEV_BOOTSTRAP_STATE}-modules"
# DevBootstrap / Source modules location
declare DEV_BOOTSTRAP_PATH_LIB="${DEV_BOOTSTRAP_PATH_ROOT}/lib"

# DevBootstrap / List of module files for the initial bin/
declare DEV_BOOTSTRAP_FILES=''
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/bashlib64/bin/dev-env-bashlib64"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/bashlib64/bin/dev-lib-bashlib64"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/dev-init"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/dev-lib-base"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/dev-profile-create"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/dev-profile-remove"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/dev-profile-list"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/dev-set"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/installer64/bin/dev-env-installer64"
DEV_BOOTSTRAP_FILES+=" ${DEV_BOOTSTRAP_PATH_LIB}/installer64/bin/dev-lib-installer64"

# DevBootstrap / OS Commands
declare DEV_CMD_CAT='cat'
declare DEV_CMD_CHMOD='chmod'
declare DEV_CMD_CP='cp'
declare DEV_CMD_DIFF='diff'
declare DEV_CMD_MKDIR='mkdir'
declare DEV_CMD_MV='mv'
declare DEV_CMD_RM='rm'

# DevSet / Env initial values
export DEV_BASE_DOT_ENV="dot.dev.env"
export DEV_BASE_DOT_LOCAL="dot.local.env"
export DEV_BASE_DOT_SECRETS="dot.secrets.env"
export DEV_BASE_ENV='.dev.env'
export DEV_BASE_GITKEEP=".gitkeep"
export DEV_BASE_LOCAL=".local.env"
export DEV_BASE_POST=".post.env"
export DEV_BASE_SECRETS=".secrets.env"
export DEV_LIB_BASHLIB64_TARGET=''
export DEV_LIB_INSTALLER64_OWNER='automation64/installer64'
export DEV_LIB_INSTALLER64_TARGET=''
export DEV_PATH_BIN=''
export DEV_PATH_LIB=''
export DEV_PATH_ROOT=''
export DEV_PATH_TMP=''
export DEV_PROFILE=''

# Installer64 / Parameters
export INST64_BASHLIB64_TARGET=''

#
# Functions
#

function dev_bootstrap_file_is_same() {
  local file_old="$1"
  local file_new="$2"
  "$DEV_CMD_DIFF" -q "$file_old" "$file_new" >/dev/null 2>&1
}

function dev_bootstrap_duplicate_remove() {
  local file_old="$1"
  local file_new="$2"

  [[ ! -e "$file_old" || ! -e "$file_new" ]] && return 0

  if dev_bootstrap_file_is_same "$file_old" "$file_new" >/dev/null 2>&1; then
    "$DEV_CMD_RM" -f "$file_new"
  else
    "$DEV_CMD_CAT" "$file_new" >"$file_old" &&
      "$DEV_CMD_RM" -f "$file_new"
  fi
}

function dev_bootstrap_bin_populate_base() {
  local file=''
  dev_bootstrap_msg_show_task 'bootstrap helpers (dev/bin)'
  if [[ ! -d "$DEV_PATH_BIN" ]]; then
    "$DEV_CMD_MKDIR" \
      -m "$DEV_BOOTSTRAP_DIR_MODE" \
      "$DEV_PATH_BIN" ||
      return $?
  fi
  for file in $DEV_BOOTSTRAP_FILES; do
    "$DEV_CMD_CP" "$file" "$DEV_PATH_BIN" ||
      return $?
  done
}

function dev_bootstrap_bin_detect_optional() {
  local module=''

  if [[ -n "$DEV_BOOTSTRAP_MODULES" ]]; then
    if [[ ! -f "$DEV_BOOTSTRAP_MODULES_OPTIONAL" ]]; then
      for module in $DEV_BOOTSTRAP_MODULES; do
        echo "$module" >>"$DEV_BOOTSTRAP_MODULES_OPTIONAL" || return $?
      done
    else
      return 0
    fi
  fi

  [[ ! -f "$DEV_BOOTSTRAP_MODULES_OPTIONAL" ]] && return 0
  for module in $(<$DEV_BOOTSTRAP_MODULES_OPTIONAL); do
    DEV_BOOTSTRAP_MODULES+=" $module"
  done
}

function dev_bootstrap_bin_populate_optional() {
  local module_name=''
  local module_path=''

  dev_bootstrap_bin_detect_optional
  [[ -z "$DEV_BOOTSTRAP_MODULES" ]] && return 0

  dev_bootstrap_msg_show_task "add optional modules (${DEV_BOOTSTRAP_MODULES})"
  for module_name in $DEV_BOOTSTRAP_MODULES; do
    module_path="${DEV_BOOTSTRAP_PATH_LIB}/${module_name}/bin"
    if [[ -d "$module_path" ]]; then
      "$DEV_CMD_CP" "${module_path}/"* "$DEV_PATH_BIN"
    else
      dev_bootstrap_msg_show_warning "optional module content not found (${module_path})"
    fi
  done
}

function dev_bootstrap_lib_base_run() {
  dev_bootstrap_msg_show_task "deploy base tools (installer64 / bashlib64)"
  "${DEV_PATH_BIN}/dev-lib-base" >/dev/null 2>&1
}

function dev_bootstrap_dir_create() {
  local path=''
  local path_list=''

  path_list+=" $DEV_PATH_BIN"
  path_list+=" $DEV_PATH_BUILD"
  path_list+=" $DEV_PATH_DOCS"
  path_list+=" $DEV_PATH_ETC"
  path_list+=" $DEV_PATH_LIB"
  path_list+=" $DEV_PATH_LOGS"
  path_list+=" $DEV_PATH_SRC"
  path_list+=" $DEV_PATH_TEST"
  path_list+=" $DEV_PATH_TMP"
  path_list+=" $DEV_PATH_VAR"
  path_list+=" $DEV_PATH_VAULT"

  # shellcheck disable=SC2086
  for path in $path_list; do
    [[ -d "$path" ]] && continue
    dev_bootstrap_msg_show_task "create main directory structure (${path})"
    "$DEV_CMD_MKDIR" \
      -m "$DEV_BOOTSTRAP_DIR_MODE" \
      "$path" || return $?
  done

  dev_bootstrap_msg_show_task "create git path placeholders (${DEV_BASE_GITKEEP})"
  touch \
    "build/${DEV_BASE_GITKEEP}" \
    "etc/${DEV_BASE_GITKEEP}" \
    "docs/${DEV_BASE_GITKEEP}" \
    "lib/${DEV_BASE_GITKEEP}" \
    "logs/${DEV_BASE_GITKEEP}" \
    "src/${DEV_BASE_GITKEEP}" \
    "test/${DEV_BASE_GITKEEP}" \
    "tmp/${DEV_BASE_GITKEEP}" \
    "var/${DEV_BASE_GITKEEP}" \
    "vault/${DEV_BASE_GITKEEP}"
}

function dev_bootstrap_dot_env_create() {
  local file_target=''
  local file_old="$DEV_BASE_DOT_ENV"
  local file_new="${file_old}.new"

  dev_bootstrap_msg_show_task "create environment file (${file_old})"
  if [[ -f "$file_old" ]]; then
    file_target="$file_new"
  else
    file_target="$file_old"
  fi

  "$DEV_CMD_CP" "${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/${DEV_BASE_DOT_ENV}" "$file_target" &&
    "$DEV_CMD_CHMOD" "$DEV_BOOTSTRAP_FILE_MODE" "$file_target" &&
    dev_bootstrap_duplicate_remove "$file_old" "$file_new"
}

function dev_bootstrap_env_create() {
  if [[ ! -f "$DEV_BASE_ENV" ]]; then
    dev_bootstrap_msg_show_task "create environment file (${DEV_BASE_ENV})"
    "$DEV_CMD_CAT" "$DEV_BASE_DOT_ENV" >"$DEV_BASE_ENV"
    "$DEV_CMD_CHMOD" "$DEV_BOOTSTRAP_FILE_MODE" "$DEV_BASE_ENV"
  fi
}

function dev_bootstrap_gitignore_create() {
  local file_target='.gitignore'
  if [[ ! -f "$file_target" ]]; then
    dev_bootstrap_msg_show_task "create environment file (${file_target})"
    "$DEV_CMD_CAT" "$DEV_BOOTSTRAP_DOT_GITIGNORE" >"$file_target"
    "$DEV_CMD_CHMOD" "$DEV_BOOTSTRAP_FILE_MODE" "$file_target"
  fi
}

function dev_bootstrap_dot_local_create() {
  local file_target=''
  local file_old="$DEV_BASE_DOT_LOCAL"
  local file_new="${file_old}.new"

  dev_bootstrap_msg_show_task "create environment file (${file_old})"
  if [[ -f "$file_old" ]]; then
    file_target="$file_new"
  else
    file_target="$file_old"
  fi

  "$DEV_CMD_CP" "${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/${DEV_BASE_DOT_LOCAL}" "$file_target" &&
    "$DEV_CMD_CHMOD" "$DEV_BOOTSTRAP_FILE_MODE" "$file_target" &&
    dev_bootstrap_duplicate_remove "$file_old" "$file_new"
}

function dev_bootstrap_dot_secrets_create() {
  local file_target=''
  local file_old="$DEV_BASE_DOT_SECRETS"
  local file_new="${file_old}.new"

  dev_bootstrap_msg_show_task "create environment file (${file_old})"
  if [[ -f "$file_old" ]]; then
    file_target="$file_new"
  else
    file_target="$file_old"
  fi
  "$DEV_CMD_CP" "${DEV_BOOTSTRAP_PATH_LIB}/devbin64/bin/${file_old}" "$file_target" &&
    "$DEV_CMD_CHMOD" "$DEV_BOOTSTRAP_FILE_MODE" "$file_target" &&
    dev_bootstrap_duplicate_remove "$file_old" "$file_new"
}

function dev_bootstrap_dot_gitignore_create() {
  local file_target=''
  local file_old="$DEV_BOOTSTRAP_DOT_GITIGNORE"
  local file_new="${file_old}.new"

  dev_bootstrap_msg_show_task "create ignore file (${file_old})"
  if [[ -f "$file_old" ]]; then
    file_target="$file_new"
  else
    file_target="$file_old"
  fi

  # shellcheck disable=SC2016
  printf '#
# GIT Ignore
#
# * Version: 1.0.0
# * Template: 2.0.1
#

#
# Main
#

/build/*
/lib/*
/logs/*
/tmp/*
/vault/*
/%s
/%s

/.vscode

#
# Project specific exclusions
#

# Keep placeholder for empty directories
!/**/%s
' \
    "$DEV_BASE_LOCAL" \
    "$DEV_BASE_SECRETS" \
    "$DEV_BASE_GITKEEP" \
    >"$file_target" &&
    "$DEV_CMD_CHMOD" "$DEV_BOOTSTRAP_FILE_MODE" "$file_target" &&
    dev_bootstrap_duplicate_remove "$file_old" "$file_new"
}

function dev_bootstrap_dot_env_load() {
  dev_bootstrap_msg_show_task "load project variables (bin/dev-set)"
  source "${DEV_PATH_BIN}/dev-set" >/dev/null
}

function dev_bootstrap_legacy() {
  local file=''
  dev_bootstrap_msg_show_task 'migrate legacy content'

  file="${DEV_PATH_ROOT}/.env"
  if [[ -f "$file" ]]; then
    if dev_bootstrap_file_is_same "$file" "${DEV_PATH_ROOT}/dot.env"; then
      dev_bootstrap_msg_show_warning "legacy file detected. Removing it as it is no longer used (${file})"
      "$DEV_CMD_RM" -f "$file"
    else
      dev_bootstrap_msg_show_warning 'legacy file detected. Original file renamed. (.env -> .env.needs-migration)'
      dev_bootstrap_msg_show_warning 'pending migration detected. Manually migrate the content and remove the file (.env.pending-migration -> .dev.env)'
      "$DEV_CMD_MV" -f "$file" "${file}.pending-migration"
    fi
  fi

  file="${DEV_PATH_ROOT}/dot.env"
  if [[ -f "$file" ]]; then
    dev_bootstrap_msg_show_warning "legacy file detected. Removing it as it is no longer used (${file})"
    "$DEV_CMD_RM" -f "$file"
  fi

  file="${DEV_PATH_ROOT}/${DEV_BASE_SECRETS}"
  if [[ -f "$file" ]]; then
    dev_bootstrap_msg_show_warning "legacy file detected. Moving it to the new location (${file} -> ${DEV_PATH_VAULT})"
    "$DEV_CMD_MV" -f "$file" "$DEV_PATH_VAULT"
  fi
}

function dev_bootstrap_msg_show_warning() {
  local msg="$1"
  echo "devbin64:Warning: ${msg}" 2>&1
}

function dev_bootstrap_msg_show_error() {
  local msg="$1"
  echo "devbin64:Error: ${msg}" 2>&1
}

function dev_bootstrap_msg_show_task() {
  local msg="$1"
  echo "devbin64:Task: ${msg}"
}

function dev_bootstrap_initialize() {

  if [[ -z "$(command -v "$DEV_CMD_DIFF" 2>/dev/null)" ]]; then
    dev_bootstrap_msg_show_error "required command not found. Please install it and re-run the bootstrap process (${DEV_CMD_DIFF})"
    return 1
  fi

  # Initialize .env variables for the bootstrap process
  DEV_PROFILE=''
  DEV_PATH_ROOT="$(pwd)"
  DEV_PATH_BIN="${DEV_PATH_ROOT}/bin"
  DEV_PATH_LIB="${DEV_PATH_ROOT}/lib"
  DEV_LIB_BASHLIB64_TARGET="${DEV_PATH_LIB}/${DEV_BOOTSTRAP_BASHLIB64_NAME}"
  DEV_LIB_INSTALLER64_TARGET="${DEV_PATH_LIB}/${DEV_BOOTSTRAP_INSTALLER64_NAME}"

  # Initialize Installer64 parameters
  INST64_INSTALLER64_TARGET="$DEV_LIB_INSTALLER64_TARGET"
  INST64_BASHLIB64_TARGET="$DEV_LIB_BASHLIB64_TARGET"

  if [[ ! -d "$DEV_BOOTSTRAP_PATH_LIB" ]]; then
    dev_bootstrap_msg_show_error "unable to locate module library (${DEV_BOOTSTRAP_PATH_LIB}). Verify or update DEV_BOOTSTRAP_PATH_LIB with the correct path location" 2>&1
    return 1
  fi
}

#
# Main
#

declare dev_bootstrap_process='dev-bootstrap'
declare -i dev_bootstrap_status=0

[[ -n "$DEV_CICD_DEBUG" ]] && set -x

echo "Process: [${dev_bootstrap_process}] started"
dev_bootstrap_initialize &&
  echo "$DEV_BIN64_VERSION" >"$DEV_BOOTSTRAP_STATE" &&
  dev_bootstrap_dot_env_create &&
  dev_bootstrap_env_create &&
  dev_bootstrap_dot_local_create &&
  dev_bootstrap_dot_secrets_create &&
  dev_bootstrap_bin_populate_base &&
  dev_bootstrap_dot_env_load &&
  dev_bootstrap_dot_gitignore_create &&
  dev_bootstrap_gitignore_create &&
  dev_bootstrap_dir_create &&
  dev_bootstrap_bin_populate_optional &&
  dev_bootstrap_legacy &&
  dev_bootstrap_lib_base_run &&
  dev_bootstrap_status=$?

if ((dev_bootstrap_status == 0)); then
  echo "dev_bootstrap:Process: [${dev_bootstrap_process}] finished successfully"
else
  echo "dev_bootstrap:Process: [${dev_bootstrap_process}] finished with errors: exit-status-${dev_bootstrap_status}"
fi
exit $dev_bootstrap_status
